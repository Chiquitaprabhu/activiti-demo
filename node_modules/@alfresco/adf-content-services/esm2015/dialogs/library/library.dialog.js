/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
/*!
 * @license
 * Copyright 2019 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import { Subject, from } from 'rxjs';
import { Component, Output, EventEmitter, ViewEncapsulation } from '@angular/core';
import { FormBuilder, Validators } from '@angular/forms';
import { MatDialogRef } from '@angular/material';
import { AlfrescoApiService } from '@alfresco/adf-core';
import { debounceTime, mergeMap, takeUntil } from 'rxjs/operators';
export class LibraryDialogComponent {
    /**
     * @param {?} alfrescoApiService
     * @param {?} formBuilder
     * @param {?} dialog
     */
    constructor(alfrescoApiService, formBuilder, dialog) {
        this.alfrescoApiService = alfrescoApiService;
        this.formBuilder = formBuilder;
        this.dialog = dialog;
        /**
         * Emitted when an error occurs.
         */
        this.error = new EventEmitter();
        /**
         * Emitted when the new library is created successfully. The
         * event parameter is a SiteEntry object with the details of the
         * newly-created library.
         */
        this.success = new EventEmitter();
        this.onDestroy$ = new Subject();
        this.createTitle = 'LIBRARY.DIALOG.CREATE_TITLE';
        this.libraryTitleExists = false;
        this.visibilityOptions = [
            { value: 'PUBLIC', label: 'LIBRARY.VISIBILITY.PUBLIC', disabled: false },
            { value: 'PRIVATE', label: 'LIBRARY.VISIBILITY.PRIVATE', disabled: false },
            {
                value: 'MODERATED',
                label: 'LIBRARY.VISIBILITY.MODERATED',
                disabled: false
            }
        ];
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        /** @type {?} */
        const validators = {
            id: [
                Validators.required,
                Validators.maxLength(72),
                this.forbidSpecialCharacters
            ],
            title: [
                Validators.required,
                this.forbidOnlySpaces,
                Validators.minLength(2),
                Validators.maxLength(256)
            ],
            description: [Validators.maxLength(512)]
        };
        this.form = this.formBuilder.group({
            title: [null, validators.title],
            id: [null, validators.id, this.createSiteIdValidator()],
            description: ['', validators.description]
        });
        this.visibilityOption = this.visibilityOptions[0].value;
        this.form.controls['title'].valueChanges
            .pipe(debounceTime(300), mergeMap((/**
         * @param {?} title
         * @return {?}
         */
        (title) => this.checkLibraryNameExists(title)), (/**
         * @param {?} title
         * @return {?}
         */
        (title) => title)), takeUntil(this.onDestroy$))
            .subscribe((/**
         * @param {?} title
         * @return {?}
         */
        (title) => {
            if (!this.form.controls['id'].dirty && this.canGenerateId(title)) {
                this.form.patchValue({ id: this.sanitize(title.trim()) });
                this.form.controls['id'].markAsTouched();
            }
        }));
    }
    /**
     * @return {?}
     */
    ngOnDestroy() {
        this.onDestroy$.next(true);
        this.onDestroy$.complete();
    }
    /**
     * @return {?}
     */
    get title() {
        const { title } = this.form.value;
        return (title || '').trim();
    }
    /**
     * @return {?}
     */
    get id() {
        const { id } = this.form.value;
        return (id || '').trim();
    }
    /**
     * @return {?}
     */
    get description() {
        const { description } = this.form.value;
        return (description || '').trim();
    }
    /**
     * @return {?}
     */
    get visibility() {
        return this.visibilityOption || '';
    }
    /**
     * @return {?}
     */
    submit() {
        const { form, dialog } = this;
        if (!form.valid) {
            return;
        }
        this.create().subscribe((/**
         * @param {?} node
         * @return {?}
         */
        (node) => {
            this.success.emit(node);
            dialog.close(node);
        }), (/**
         * @param {?} error
         * @return {?}
         */
        (error) => this.handleError(error)));
    }
    /**
     * @param {?} event
     * @return {?}
     */
    visibilityChangeHandler(event) {
        this.visibilityOption = event.value;
    }
    /**
     * @private
     * @return {?}
     */
    create() {
        const { title, id, description, visibility } = this;
        /** @type {?} */
        const siteBody = (/** @type {?} */ ({
            id,
            title,
            description,
            visibility
        }));
        return from(this.alfrescoApiService.sitesApi.createSite(siteBody));
    }
    /**
     * @private
     * @param {?} input
     * @return {?}
     */
    sanitize(input) {
        return input.replace(/[\s\s]+/g, '-').replace(/[^A-Za-z0-9-]/g, '');
    }
    /**
     * @private
     * @param {?} title
     * @return {?}
     */
    canGenerateId(title) {
        return Boolean(title.replace(/[^A-Za-z0-9-]/g, '').length);
    }
    /**
     * @private
     * @param {?} error
     * @return {?}
     */
    handleError(error) {
        try {
            const { error: { statusCode } } = JSON.parse(error.message);
            if (statusCode === 409) {
                this.form.controls['id'].setErrors({
                    message: 'LIBRARY.ERRORS.CONFLICT'
                });
            }
        }
        catch (error) {
        }
        return error;
    }
    /**
     * @private
     * @param {?} libraryTitle
     * @return {?}
     */
    checkLibraryNameExists(libraryTitle) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            /** @type {?} */
            let entries = [];
            try {
                entries = (yield this.findLibraryByTitle(libraryTitle)).list.entries;
            }
            catch (_a) {
                entries = [];
            }
            if (entries.length) {
                this.libraryTitleExists = entries[0].entry.title.toLowerCase() === libraryTitle.toLowerCase();
            }
            else {
                this.libraryTitleExists = false;
            }
        });
    }
    /**
     * @private
     * @param {?} libraryTitle
     * @return {?}
     */
    findLibraryByTitle(libraryTitle) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            return this.alfrescoApiService
                .getInstance()
                .core.queriesApi.findSites(libraryTitle, {
                maxItems: 1,
                fields: ['title']
            });
        });
    }
    /**
     * @private
     * @param {?} __0
     * @return {?}
     */
    forbidSpecialCharacters({ value }) {
        if (value === null || value.length === 0) {
            return null;
        }
        /** @type {?} */
        const validCharacters = /[^A-Za-z0-9-]/;
        /** @type {?} */
        const isValid = !validCharacters.test(value);
        return isValid
            ? null
            : {
                message: 'LIBRARY.ERRORS.ILLEGAL_CHARACTERS'
            };
    }
    /**
     * @private
     * @param {?} __0
     * @return {?}
     */
    forbidOnlySpaces({ value }) {
        if (value === null || value.length === 0) {
            return null;
        }
        /** @type {?} */
        const isValid = !!(value || '').trim();
        return isValid
            ? null
            : {
                message: 'LIBRARY.ERRORS.ONLY_SPACES'
            };
    }
    /**
     * @private
     * @return {?}
     */
    createSiteIdValidator() {
        /** @type {?} */
        let timer;
        return (/**
         * @param {?} control
         * @return {?}
         */
        (control) => {
            if (timer) {
                clearTimeout(timer);
            }
            return new Promise((/**
             * @param {?} resolve
             * @return {?}
             */
            (resolve) => {
                timer = setTimeout((/**
                 * @return {?}
                 */
                () => {
                    return from(this.alfrescoApiService.sitesApi.getSite(control.value)).subscribe((/**
                     * @return {?}
                     */
                    () => resolve({ message: 'LIBRARY.ERRORS.EXISTENT_SITE' })), (/**
                     * @return {?}
                     */
                    () => resolve(null)));
                }), 300);
            }));
        });
    }
}
LibraryDialogComponent.decorators = [
    { type: Component, args: [{
                selector: 'adf-library-dialog',
                template: "<h2 mat-dialog-title>{{ createTitle | translate }}</h2>\n\n<mat-dialog-content>\n  <form novalidate [formGroup]=\"form\" (submit)=\"submit()\">\n    <mat-form-field>\n      <input\n        placeholder=\"{{ 'LIBRARY.DIALOG.FORM.NAME' | translate }}\"\n        required\n        matInput\n        autofocus\n        formControlName=\"title\"\n        autocomplete=\"off\"\n      />\n\n      <mat-hint *ngIf=\"libraryTitleExists\">{{\n        'LIBRARY.HINTS.SITE_TITLE_EXISTS' | translate\n      }}</mat-hint>\n      <mat-error *ngIf=\"form.controls['title'].hasError('maxlength')\">\n        {{ 'LIBRARY.ERRORS.TITLE_TOO_LONG' | translate }}\n      </mat-error>\n\n      <mat-error *ngIf=\"form.controls['title'].hasError('minlength')\">\n        {{ 'LIBRARY.ERRORS.TITLE_TOO_SHORT' | translate }}\n      </mat-error>\n\n      <mat-error *ngIf=\"form.controls['title'].errors?.message\">\n        {{ form.controls['title'].errors?.message | translate }}\n      </mat-error>\n    </mat-form-field>\n\n    <mat-form-field>\n      <input\n        required\n        placeholder=\"{{ 'LIBRARY.DIALOG.FORM.SITE_ID' | translate }}\"\n        matInput\n        formControlName=\"id\"\n        autocomplete=\"off\"\n      />\n\n      <mat-error *ngIf=\"form.controls['id'].errors?.message\">\n        {{ form.controls['id'].errors?.message | translate }}\n      </mat-error>\n\n      <mat-error *ngIf=\"form.controls['id'].hasError('maxlength')\">\n        {{ 'LIBRARY.ERRORS.ID_TOO_LONG' | translate }}\n      </mat-error>\n    </mat-form-field>\n\n    <mat-form-field>\n      <textarea\n        matInput\n        placeholder=\"{{ 'LIBRARY.DIALOG.FORM.DESCRIPTION' | translate }}\"\n        rows=\"3\"\n        formControlName=\"description\"\n      ></textarea>\n\n      <mat-error *ngIf=\"form.controls['description'].hasError('maxlength')\">\n        {{ 'LIBRARY.ERRORS.DESCRIPTION_TOO_LONG' | translate }}\n      </mat-error>\n    </mat-form-field>\n\n    <mat-radio-group\n      [ngModelOptions]=\"{ standalone: true }\"\n      [(ngModel)]=\"visibilityOption\"\n      (change)=\"visibilityChangeHandler($event)\"\n    >\n      <mat-radio-button\n        color=\"primary\"\n        [disabled]=\"option.disabled\"\n        *ngFor=\"let option of visibilityOptions\"\n        [attr.data-automation-id]=\"option.value\"\n        [value]=\"option.value\"\n        [checked]=\"visibilityOption.value === option.value\"\n      >\n        {{ option.label | translate }}\n      </mat-radio-button>\n    </mat-radio-group>\n  </form>\n</mat-dialog-content>\n\n<mat-dialog-actions class=\"adf-action-buttons\">\n  <button mat-button mat-dialog-close data-automation-id=\"cancel-library-id\">\n    {{ 'LIBRARY.DIALOG.CANCEL' | translate }}\n  </button>\n\n  <button\n    color=\"primary\"\n    mat-button\n    (click)=\"submit()\"\n    [disabled]=\"!form.valid\"\n    data-automation-id=\"create-library-id\"\n  >\n    {{ 'LIBRARY.DIALOG.CREATE' | translate }}\n  </button>\n</mat-dialog-actions>\n",
                encapsulation: ViewEncapsulation.None,
                host: { class: 'adf-library-dialog' },
                styles: [".adf-library-dialog .mat-radio-group{display:flex;flex-direction:column;margin:0 0 20px}.adf-library-dialog .mat-radio-group .mat-radio-button{margin:10px 0}.adf-library-dialog .mat-form-field{width:100%}.adf-library-dialog mat-form-field{padding-top:20px}.adf-library-dialog .adf-action-buttons{display:flex;flex-direction:row;justify-content:flex-end}.adf-library-dialog .adf-action-buttons .mat-button{text-transform:uppercase}"]
            }] }
];
/** @nocollapse */
LibraryDialogComponent.ctorParameters = () => [
    { type: AlfrescoApiService },
    { type: FormBuilder },
    { type: MatDialogRef }
];
LibraryDialogComponent.propDecorators = {
    error: [{ type: Output }],
    success: [{ type: Output }]
};
if (false) {
    /**
     * Emitted when an error occurs.
     * @type {?}
     */
    LibraryDialogComponent.prototype.error;
    /**
     * Emitted when the new library is created successfully. The
     * event parameter is a SiteEntry object with the details of the
     * newly-created library.
     * @type {?}
     */
    LibraryDialogComponent.prototype.success;
    /** @type {?} */
    LibraryDialogComponent.prototype.onDestroy$;
    /** @type {?} */
    LibraryDialogComponent.prototype.createTitle;
    /** @type {?} */
    LibraryDialogComponent.prototype.libraryTitleExists;
    /** @type {?} */
    LibraryDialogComponent.prototype.form;
    /** @type {?} */
    LibraryDialogComponent.prototype.visibilityOption;
    /** @type {?} */
    LibraryDialogComponent.prototype.visibilityOptions;
    /**
     * @type {?}
     * @private
     */
    LibraryDialogComponent.prototype.alfrescoApiService;
    /**
     * @type {?}
     * @private
     */
    LibraryDialogComponent.prototype.formBuilder;
    /**
     * @type {?}
     * @private
     */
    LibraryDialogComponent.prototype.dialog;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGlicmFyeS5kaWFsb2cuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYWxmcmVzY28vYWRmLWNvbnRlbnQtc2VydmljZXMvIiwic291cmNlcyI6WyJkaWFsb2dzL2xpYnJhcnkvbGlicmFyeS5kaWFsb2cudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBaUJBLE9BQU8sRUFBYyxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ2pELE9BQU8sRUFDTCxTQUFTLEVBRVQsTUFBTSxFQUNOLFlBQVksRUFFWixpQkFBaUIsRUFDbEIsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUNMLFdBQVcsRUFFWCxVQUFVLEVBR1gsTUFBTSxnQkFBZ0IsQ0FBQztBQUN4QixPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFFakQsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDeEQsT0FBTyxFQUFFLFlBQVksRUFBRSxRQUFRLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFTbkUsTUFBTSxPQUFPLHNCQUFzQjs7Ozs7O0lBNEJqQyxZQUNVLGtCQUFzQyxFQUN0QyxXQUF3QixFQUN4QixNQUE0QztRQUY1Qyx1QkFBa0IsR0FBbEIsa0JBQWtCLENBQW9CO1FBQ3RDLGdCQUFXLEdBQVgsV0FBVyxDQUFhO1FBQ3hCLFdBQU0sR0FBTixNQUFNLENBQXNDOzs7O1FBNUJ0RCxVQUFLLEdBQXNCLElBQUksWUFBWSxFQUFPLENBQUM7Ozs7OztRQU9uRCxZQUFPLEdBQXNCLElBQUksWUFBWSxFQUFPLENBQUM7UUFFckQsZUFBVSxHQUFxQixJQUFJLE9BQU8sRUFBVyxDQUFDO1FBRXRELGdCQUFXLEdBQUcsNkJBQTZCLENBQUM7UUFDNUMsdUJBQWtCLEdBQUcsS0FBSyxDQUFDO1FBRzNCLHNCQUFpQixHQUFHO1lBQ2xCLEVBQUUsS0FBSyxFQUFFLFFBQVEsRUFBRSxLQUFL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b3VyY2VzQ29udGVudCI6WyIvKiFcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgMjAxOSBBbGZyZXNjbyBTb2Z0d2FyZSwgTHRkLlxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG4gKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBTdWJqZWN0LCBmcm9tIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQge1xuICBDb21wb25lbnQsXG4gIE9uSW5pdCxcbiAgT3V0cHV0LFxuICBFdmVudEVtaXR0ZXIsXG4gIE9uRGVzdHJveSxcbiAgVmlld0VuY2Fwc3VsYXRpb25cbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge1xuICBGb3JtQnVpbGRlcixcbiAgRm9ybUdyb3VwLFxuICBWYWxpZGF0b3JzLFxuICBGb3JtQ29udHJvbCxcbiAgQWJzdHJhY3RDb250cm9sXG59IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJztcbmltcG9ydCB7IE1hdERpYWxvZ1JlZiB9IGZyb20gJ0Bhbmd1bGFyL21hdGVyaWFsJztcbmltcG9ydCB7IFNpdGVCb2R5Q3JlYXRlLCBTaXRlRW50cnksIFNpdGVQYWdpbmcgfSBmcm9tICdAYWxmcmVzY28vanMtYXBpJztcbmltcG9ydCB7IEFsZnJlc2NvQXBpU2VydmljZSB9IGZyb20gJ0BhbGZyZXNjby9hZGYtY29yZSc7XG5pbXBvcnQgeyBkZWJvdW5jZVRpbWUsIG1lcmdlTWFwLCB0YWtlVW50aWwgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ2FkZi1saWJyYXJ5LWRpYWxvZycsXG4gIHN0eWxlVXJsczogWycuL2xpYnJhcnkuZGlhbG9nLnNjc3MnXSxcbiAgdGVtcGxhdGVVcmw6ICcuL2xpYnJhcnkuZGlhbG9nLmh0bWwnLFxuICBlbmNhcHN1bGF0aW9uOiBWaWV3RW5jYXBzdWxhdGlvbi5Ob25lLFxuICBob3N0OiB7IGNsYXNzOiAnYWRmLWxpYnJhcnktZGlhbG9nJyB9XG59KVxuZXhwb3J0IGNsYXNzIExpYnJhcnlEaWFsb2dDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQsIE9uRGVzdHJveSB7XG4gIC8qKiBFbWl0dGVkIHdoZW4gYW4gZXJyb3Igb2NjdXJzLiAqL1xuICBAT3V0cHV0KClcbiAgZXJyb3I6IEV2ZW50RW1pdHRlcjxhbnk+ID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XG5cbiAgLyoqIEVtaXR0ZWQgd2hlbiB0aGUgbmV3IGxpYnJhcnkgaXMgY3JlYXRlZCBzdWNjZXNzZnVsbHkuIFRoZVxuICAgKiBldmVudCBwYXJhbWV0ZXIgaXMgYSBTaXRlRW50cnkgb2JqZWN0IHdpdGggdGhlIGRldGFpbHMgb2YgdGhlXG4gICAqIG5ld2x5LWNyZWF0ZWQgbGlicmFyeS5cbiAgICovXG4gIEBPdXRwdXQoKVxuICBzdWNjZXNzOiBFdmVudEVtaXR0ZXI8YW55PiA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xuXG4gIG9uRGVzdHJveSQ6IFN1YmplY3Q8Ym9vbGVhbj4gPSBuZXcgU3ViamVjdDxib29sZWFuPigpO1xuXG4gIGNyZWF0ZVRpdGxlID0gJ0xJQlJBUlkuRElBTE9HLkNSRUFURV9USVRMRSc7XG4gIGxpYnJhcnlUaXRsZUV4aXN0cyA9IGZhbHNlO1xuICBmb3JtOiBGb3JtR3JvdXA7XG4gIHZpc2liaWxpdHlPcHRpb246IGFueTtcbiAgdmlzaWJpbGl0eU9wdGlvbnMgPSBbXG4gICAgeyB2YWx1ZTogJ1BVQkxJQycsIGxhYmVsOiAnTElCUkFSWS5WSVNJQklMSVRZLlBVQkxJQycsIGRpc2FibGVkOiBmYWxzZSB9LFxuICAgIHsgdmFsdWU6ICdQUklWQVRFJywgbGFiZWw6ICdMSUJSQVJZLlZJU0lCSUxJVFkuUFJJVkFURScsIGRpc2FibGVkOiBmYWxzZSB9LFxuICAgIHtcbiAgICAgIHZhbHVlOiAnTU9ERVJBVEVEJyxcbiAgICAgIGxhYmVsOiAnTElCUkFSWS5WSVNJQklMSVRZLk1PREVSQVRFRCcsXG4gICAgICBkaXNhYmxlZDogZmFsc2VcbiAgICB9XG4gIF07XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBhbGZyZXNjb0FwaVNlcnZpY2U6IEFsZnJlc2NvQXBpU2VydmljZSxcbiAgICBwcml2YXRlIGZvcm1CdWlsZGVyOiBGb3JtQnVpbGRlcixcbiAgICBwcml2YXRlIGRpYWxvZzogTWF0RGlhbG9nUmVmPExpYnJhcnlEaWFsb2dDb21wb25lbnQ+XG4gICkge31cblxuICBuZ09uSW5pdCgpIHtcbiAgICBjb25zdCB2YWxpZGF0b3JzID0ge1xuICAgICAgaWQ6IFtcbiAgICAgICAgVmFsaWRhdG9ycy5yZXF1aXJlZCxcbiAgICAgICAgVmFsaWRhdG9ycy5tYXhMZW5ndGgoNzIpLFxuICAgICAgICB0aGlzLmZvcmJpZFNwZWNpYWxDaGFyYWN0ZXJzXG4gICAgICBdLFxuICAgICAgdGl0bGU6IFtcbiAgICAgICAgVmFsaWRhdG9ycy5yZXF1aXJlZCxcbiAgICAgICAgdGhpcy5mb3JiaWRPbmx5U3BhY2VzLFxuICAgICAgICBWYWxpZGF0b3JzLm1pbkxlbmd0aCgyKSxcbiAgICAgICAgVmFsaWRhdG9ycy5tYXhMZW5ndGgoMjU2KVxuICAgICAgXSxcbiAgICAgIGRlc2NyaXB0aW9uOiBbVmFsaWRhdG9ycy5tYXhMZW5ndGgoNTEyKV1cbiAgICB9O1xuXG4gICAgdGhpcy5mb3JtID0gdGhpcy5mb3JtQnVpbGRlci5ncm91cCh7XG4gICAgICB0aXRsZTogW251bGwsIHZhbGlkYXRvcnMudGl0bGVdLFxuICAgICAgaWQ6IFtudWxsLCB2YWxpZGF0b3JzLmlkLCB0aGlzLmNyZWF0ZVNpdGVJZFZhbGlkYXRvcigpXSxcbiAgICAgIGRlc2NyaXB0aW9uOiBbJycsIHZhbGlkYXRvcnMuZGVzY3JpcHRpb25dXG4gICAgfSk7XG5cbiAgICB0aGlzLnZpc2liaWxpdHlPcHRpb24gPSB0aGlzLnZpc2liaWxpdHlPcHRpb25zWzBdLnZhbHVlO1xuXG4gICAgdGhpcy5mb3JtLmNvbnRyb2xzWyd0aXRsZSddLnZhbHVlQ2hhbmdlc1xuICAgICAgLnBpcGUoXG4gICAgICAgIGRlYm91bmNlVGltZSgzMDApLFxuICAgICAgICBtZXJnZU1hcChcbiAgICAgICAgICAgICh0aXRsZSkgPT4gdGhpcy5jaGVja0xpYnJhcnlOYW1lRXhpc3RzKHRpdGxlKSxcbiAgICAgICAgICAgICh0aXRsZSkgPT4gdGl0bGVcbiAgICAgICAgKSxcbiAgICAgICAgdGFrZVVudGlsKHRoaXMub25EZXN0cm95JClcbiAgICAgIClcbiAgICAgIC5zdWJzY3JpYmUoKHRpdGxlOiBzdHJpbmcpID0+IHtcbiAgICAgICAgaWYgKCF0aGlzLmZvcm0uY29udHJvbHNbJ2lkJ10uZGlydHkgJiYgdGhpcy5jYW5HZW5lcmF0ZUlkKHRpdGxlKSkge1xuICAgICAgICAgIHRoaXMuZm9ybS5wYXRjaFZhbHVlKHsgaWQ6IHRoaXMuc2FuaXRpemUodGl0bGUudHJpbSgpKSB9KTtcbiAgICAgICAgICB0aGlzLmZvcm0uY29udHJvbHNbJ2lkJ10ubWFya0FzVG91Y2hlZCgpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgfVxuXG4gIG5nT25EZXN0cm95KCkge1xuICAgIHRoaXMub25EZXN0cm95JC5uZXh0KHRydWUpO1xuICAgIHRoaXMub25EZXN0cm95JC5jb21wbGV0ZSgpO1xuICB9XG5cbiAgZ2V0IHRpdGxlKCk6IHN0cmluZyB7XG4gICAgY29uc3QgeyB0aXRsZSB9ID0gdGhpcy5mb3JtLnZhbHVlO1xuXG4gICAgcmV0dXJuICh0aXRsZSB8fCAnJykudHJpbSgpO1xuICB9XG5cbiAgZ2V0IGlkKCk6IHN0cmluZyB7XG4gICAgY29uc3QgeyBpZCB9ID0gdGhpcy5mb3JtLnZhbHVlO1xuXG4gICAgcmV0dXJuIChpZCB8fCAnJykudHJpbSgpO1xuICB9XG5cbiAgZ2V0IGRlc2NyaXB0aW9uKCk6IHN0cmluZyB7XG4gICAgY29uc3QgeyBkZXNjcmlwdGlvbiB9ID0gdGhpcy5mb3JtLnZhbHVlO1xuXG4gICAgcmV0dXJuIChkZXNjcmlwdGlvbiB8fCAnJykudHJpbSgpO1xuICB9XG5cbiAgZ2V0IHZpc2liaWxpdHkoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy52aXNpYmlsaXR5T3B0aW9uIHx8ICcnO1xuICB9XG5cbiAgc3VibWl0KCkge1xuICAgIGNvbnN0IHsgZm9ybSwgZGlhbG9nIH0gPSB0aGlzO1xuXG4gICAgaWYgKCFmb3JtLnZhbGlkKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdGhpcy5jcmVhdGUoKS5zdWJzY3JpYmUoXG4gICAgICAobm9kZTogU2l0ZUVudHJ5KSA9PiB7XG4gICAgICAgIHRoaXMuc3VjY2Vzcy5lbWl0KG5vZGUpO1xuICAgICAgICBkaWFsb2cuY2xvc2Uobm9kZSk7XG4gICAgICB9LFxuICAgICAgKGVycm9yKSA9PiB0aGlzLmhhbmRsZUVycm9yKGVycm9yKVxuICAgICk7XG4gIH1cblxuICB2aXNpYmlsaXR5Q2hhbmdlSGFuZGxlcihldmVudCkge1xuICAgIHRoaXMudmlzaWJpbGl0eU9wdGlvbiA9IGV2ZW50LnZhbHVlO1xuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGUoKTogT2JzZXJ2YWJsZTxTaXRlRW50cnk+IHtcbiAgICBjb25zdCB7IHRpdGxlLCBpZCwgZGVzY3JpcHRpb24sIHZpc2liaWxpdHkgfSA9IHRoaXM7XG4gICAgY29uc3Qgc2l0ZUJvZHkgPSA8U2l0ZUJvZHlDcmVhdGU+IHtcbiAgICAgIGlkLFxuICAgICAgdGl0bGUsXG4gICAgICBkZXNjcmlwdGlvbixcbiAgICAgIHZpc2liaWxpdHlcbiAgICB9O1xuXG4gICAgcmV0dXJuIGZyb20odGhpcy5hbGZyZXNjb0FwaVNlcnZpY2Uuc2l0ZXNBcGkuY3JlYXRlU2l0ZShzaXRlQm9keSkpO1xuICB9XG5cbiAgcHJpdmF0ZSBzYW5pdGl6ZShpbnB1dDogc3RyaW5nKSB7XG4gICAgcmV0dXJuIGlucHV0LnJlcGxhY2UoL1tcXHNcXHNdKy9nLCAnLScpLnJlcGxhY2UoL1teQS1aYS16MC05LV0vZywgJycpO1xuICB9XG5cbiAgcHJpdmF0ZSBjYW5HZW5lcmF0ZUlkKHRpdGxlKSB7XG4gICAgcmV0dXJuIEJvb2xlYW4odGl0bGUucmVwbGFjZSgvW15BLVphLXowLTktXS9nLCAnJykubGVuZ3RoKTtcbiAgfVxuXG4gIHByaXZhdGUgaGFuZGxlRXJyb3IoZXJyb3I6IGFueSk6IGFueSB7XG4gICAgICB0cnkge1xuICAgICAgICAgIGNvbnN0IHtcbiAgICAgICAgICAgICAgZXJyb3I6IHsgc3RhdHVzQ29kZSB9XG4gICAgICAgICAgfSA9IEpTT04ucGFyc2UoZXJyb3IubWVzc2FnZSk7XG5cbiAgICAgICAgICBpZiAoc3RhdHVzQ29kZSA9PT0gNDA5KSB7XG4gICAgICAgICAgICAgIHRoaXMuZm9ybS5jb250cm9sc1snaWQnXS5zZXRFcnJvcnMoe1xuICAgICAgICAgICAgICAgICAgbWVzc2FnZTogJ0xJQlJBUlkuRVJST1JTLkNPTkZMSUNUJ1xuICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICB9XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuXG4gICAgICB9XG5cbiAgICAgIHJldHVybiBlcnJvcjtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgY2hlY2tMaWJyYXJ5TmFtZUV4aXN0cyhsaWJyYXJ5VGl0bGU6IHN0cmluZykge1xuICAgIGxldCBlbnRyaWVzID0gW107XG5cbiAgICB0cnkge1xuICAgICAgICBlbnRyaWVzID0gKGF3YWl0IHRoaXMuZmluZExpYnJhcnlCeVRpdGxlKGxpYnJhcnlUaXRsZSkpLmxpc3QuZW50cmllcztcbiAgICB9IGNhdGNoIHtcbiAgICAgICAgZW50cmllcyA9IFtdO1xuICAgIH1cblxuICAgIGlmIChlbnRyaWVzLmxlbmd0aCkge1xuICAgICAgdGhpcy5saWJyYXJ5VGl0bGVFeGlzdHMgPSBlbnRyaWVzWzBdLmVudHJ5LnRpdGxlLnRvTG93ZXJDYXNlKCkgPT09IGxpYnJhcnlUaXRsZS50b0xvd2VyQ2FzZSgpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmxpYnJhcnlUaXRsZUV4aXN0cyA9IGZhbHNlO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgZmluZExpYnJhcnlCeVRpdGxlKGxpYnJhcnlUaXRsZTogc3RyaW5nKTogUHJvbWlzZTxTaXRlUGFnaW5nPiB7XG4gICAgcmV0dXJuIHRoaXMuYWxmcmVzY29BcGlTZXJ2aWNlXG4gICAgICAuZ2V0SW5zdGFuY2UoKVxuICAgICAgLmNvcmUucXVlcmllc0FwaS5maW5kU2l0ZXMobGlicmFyeVRpdGxlLCB7XG4gICAgICAgIG1heEl0ZW1zOiAxLFxuICAgICAgICBmaWVsZHM6IFsndGl0bGUnXVxuICAgICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGZvcmJpZFNwZWNpYWxDaGFyYWN0ZXJzKHsgdmFsdWUgfTogRm9ybUNvbnRyb2wpIHtcbiAgICBpZiAodmFsdWUgPT09IG51bGwgfHwgdmFsdWUubGVuZ3RoID09PSAwKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICBjb25zdCB2YWxpZENoYXJhY3RlcnM6IFJlZ0V4cCA9IC9bXkEtWmEtejAtOS1dLztcbiAgICBjb25zdCBpc1ZhbGlkOiBib29sZWFuID0gIXZhbGlkQ2hhcmFjdGVycy50ZXN0KHZhbHVlKTtcblxuICAgIHJldHVybiBpc1ZhbGlkXG4gICAgICA/IG51bGxcbiAgICAgIDoge1xuICAgICAgICAgIG1lc3NhZ2U6ICdMSUJSQVJZLkVSUk9SUy5JTExFR0FMX0NIQVJBQ1RFUlMnXG4gICAgICAgIH07XG4gIH1cblxuICBwcml2YXRlIGZvcmJpZE9ubHlTcGFjZXMoeyB2YWx1ZSB9OiBGb3JtQ29udHJvbCkge1xuICAgIGlmICh2YWx1ZSA9PT0gbnVsbCB8fCB2YWx1ZS5sZW5ndGggPT09IDApIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIGNvbnN0IGlzVmFsaWQ6IGJvb2xlYW4gPSAhISh2YWx1ZSB8fCAnJykudHJpbSgpO1xuXG4gICAgcmV0dXJuIGlzVmFsaWRcbiAgICAgID8gbnVsbFxuICAgICAgOiB7XG4gICAgICAgICAgbWVzc2FnZTogJ0xJQlJBUlkuRVJST1JTLk9OTFlfU1BBQ0VTJ1xuICAgICAgICB9O1xuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVTaXRlSWRWYWxpZGF0b3IoKSB7XG4gICAgbGV0IHRpbWVyO1xuXG4gICAgcmV0dXJuIChjb250cm9sOiBBYnN0cmFjdENvbnRyb2wpID0+IHtcbiAgICAgIGlmICh0aW1lcikge1xuICAgICAgICBjbGVhclRpbWVvdXQodGltZXIpO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcbiAgICAgICAgdGltZXIgPSBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICByZXR1cm4gZnJvbShcbiAgICAgICAgICAgIHRoaXMuYWxmcmVzY29BcGlTZXJ2aWNlLnNpdGVzQXBpLmdldFNpdGUoY29udHJvbC52YWx1ZSlcbiAgICAgICAgICApLnN1YnNjcmliZShcbiAgICAgICAgICAgICgpID0+IHJlc29sdmUoeyBtZXNzYWdlOiAnTElCUkFSWS5FUlJPUlMuRVhJU1RFTlRfU0lURScgfSksXG4gICAgICAgICAgICAoKSA9PiByZXNvbHZlKG51bGwpXG4gICAgICAgICAgKTtcbiAgICAgICAgfSwgMzAwKTtcbiAgICAgIH0pO1xuICAgIH07XG4gIH1cbn1cbiJdfQ==