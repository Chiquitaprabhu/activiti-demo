/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
/*!
 * @license
 * Copyright 2019 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import { HttpClient } from '@angular/common/http';
import { Injectable } from '@angular/core';
import { ContentActionType } from '../config/action.extensions';
import { filterEnabled, getValue, mergeObjects, sortByOrder } from '../config/extension-utils';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
var ExtensionLoaderService = /** @class */ (function () {
    function ExtensionLoaderService(http) {
        this.http = http;
    }
    /**
     * @param {?} configPath
     * @param {?} pluginsPath
     * @param {?=} extensions
     * @return {?}
     */
    ExtensionLoaderService.prototype.load = /**
     * @param {?} configPath
     * @param {?} pluginsPath
     * @param {?=} extensions
     * @return {?}
     */
    function (configPath, pluginsPath, extensions) {
        var _this = this;
        return new Promise((/**
         * @param {?} resolve
         * @return {?}
         */
        function (resolve) {
            _this.loadConfig(configPath, 0).then((/**
             * @param {?} result
             * @return {?}
             */
            function (result) {
                if (result) {
                    /** @type {?} */
                    var config_1 = result.config;
                    /** @type {?} */
                    var override = sessionStorage.getItem('app.extension.config');
                    if (override) {
                        config_1 = JSON.parse(override);
                    }
                    if (config_1.$references && config_1.$references.length > 0) {
                        /** @type {?} */
                        var plugins = config_1.$references.map((/**
                         * @param {?} name
                         * @param {?} idx
                         * @return {?}
                         */
                        function (name, idx) {
                            return _this.loadConfig(pluginsPath + "/" + name, idx);
                        }));
                        Promise.all(plugins).then((/**
                         * @param {?} results
                         * @return {?}
                         */
                        function (results) {
                            /** @type {?} */
                            var configs = results
                                .filter((/**
                             * @param {?} entry
                             * @return {?}
                             */
                            function (entry) { return entry; }))
                                .sort(sortByOrder)
                                .map((/**
                             * @param {?} entry
                             * @return {?}
                             */
                            function (entry) { return entry.config; }));
                            if (extensions && extensions.length > 0) {
                                configs.push.apply(configs, tslib_1.__spread(extensions));
                            }
                            if (configs.length > 0) {
                                config_1 = mergeObjects.apply(void 0, tslib_1.__spread([config_1], configs));
                            }
                            config_1 = tslib_1.__assign({}, config_1, _this.getMetadata(result.config), { $references: configs.map((/**
                                 * @param {?} ext
                                 * @return {?}
                                 */
                                function (ext) { return _this.getMetadata(ext); })) });
                            resolve(config_1);
                        }));
                    }
                    else {
                        resolve(config_1);
                    }
                }
            }));
        }));
    };
    /**
     * @protected
     * @param {?} config
     * @return {?}
     */
    ExtensionLoaderService.prototype.getMetadata = /**
     * @protected
     * @param {?} config
     * @return {?}
     */
    function (config) {
        /** @type {?} */
        var result = {};
        Object
            .keys(config)
            .filter((/**
         * @param {?} key
         * @return {?}
         */
        function (key) { return key.startsWith('$'); }))
            .forEach((/**
         * @param {?} key
         * @return {?}
         */
        function (key) {
            result[key] = config[key];
        }));
        return result;
    };
    /**
     * @protected
     * @param {?} url
     * @param {?} order
     * @return {?}
     */
    ExtensionLoaderService.prototype.loadConfig = /**
     * @protected
     * @param {?} url
     * @param {?} order
     * @return {?}
     */
    function (url, order) {
        var _this = this;
        return new Promise((/**
         * @param {?} resolve
         * @return {?}
         */
        function (resolve) {
            _this.http.get(url).subscribe((/**
             * @param {?} config
             * @return {?}
             */
            function (config) {
                resolve({
                    order: order,
                    config: config
                });
            }), (/**
             * @return {?}
             */
            function () {
                resolve(null);
            }));
        }));
    };
    /**
     * Retrieves configuration elements.
     * Filters element by **enabled** and **order** attributes.
     * Example:
     *  `getElements<ViewerExtensionRef>(config, 'features.viewer.content')`
     */
    /**
     * Retrieves configuration elements.
     * Filters element by **enabled** and **order** attributes.
     * Example:
     *  `getElements<ViewerExtensionRef>(config, 'features.viewer.content')`
     * @template T
     * @param {?} config
     * @param {?} key
     * @param {?=} fallback
     * @return {?}
     */
    ExtensionLoaderService.prototype.getElements = /**
     * Retrieves configuration elements.
     * Filters element by **enabled** and **order** attributes.
     * Example:
     *  `getElements<ViewerExtensionRef>(config, 'features.viewer.content')`
     * @template T
     * @param {?} config
     * @param {?} key
     * @param {?=} fallback
     * @return {?}
     */
    function (config, key, fallback) {
        if (fallback === void 0) { fallback = []; }
        /** @type {?} */
        var values = getValue(config, key) || fallback || [];
        return values.filter(filterEnabled).sort(sortByOrder);
    };
    /**
     * @param {?} config
     * @param {?} key
     * @return {?}
     */
    ExtensionLoaderService.prototype.getContentActions = /**
     * @param {?} config
     * @param {?} key
     * @return {?}
     */
    function (config, key) {
        return this.getElements(config, key).map(this.setActionDefaults);
    };
    /**
     * @param {?} config
     * @return {?}
     */
    ExtensionLoaderService.prototype.getRules = /**
     * @param {?} config
     * @return {?}
     */
    function (config) {
        if (config && config.rules) {
            return config.rules;
        }
        return [];
    };
    /**
     * @param {?} config
     * @return {?}
     */
    ExtensionLoaderService.prototype.getRoutes = /**
     * @param {?} config
     * @return {?}
     */
    function (config) {
        if (config) {
            return config.routes || [];
        }
        return [];
    };
    /**
     * @param {?} config
     * @return {?}
     */
    ExtensionLoaderService.prototype.getActions = /**
     * @param {?} config
     * @return {?}
     */
    function (config) {
        if (config) {
            return config.actions || [];
        }
        return [];
    };
    /**
     * @param {?} config
     * @return {?}
     */
    ExtensionLoaderService.prototype.getFeatures = /**
     * @param {?} config
     * @return {?}
     */
    function (config) {
        if (config) {
            return config.features || [];
        }
        return [];
    };
    /**
     * @protected
     * @param {?} action
     * @return {?}
     */
    ExtensionLoaderService.prototype.setActionDefaults = /**
     * @protected
     * @param {?} action
     * @return {?}
     */
    function (action) {
        if (action) {
            action.type = action.type || ContentActionType.default;
            action.icon = action.icon || 'extension';
        }
        return action;
    };
    ExtensionLoaderService.decorators = [
        { type: Injectable, args: [{
                    providedIn: 'root'
                },] }
    ];
    /** @nocollapse */
    ExtensionLoaderService.ctorParameters = function () { return [
        { type: HttpClient }
    ]; };
    /** @nocollapse */ ExtensionLoaderService.ngInjectableDef = i0.defineInjectable({ factory: function ExtensionLoaderService_Factory() { return new ExtensionLoaderService(i0.inject(i1.HttpClient)); }, token: ExtensionLoaderService, providedIn: "root" });
    return ExtensionLoaderService;
}());
export { ExtensionLoaderService };
if (false) {
    /**
     * @type {?}
     * @private
     */
    ExtensionLoaderService.prototype.http;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXh0ZW5zaW9uLWxvYWRlci5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGFsZnJlc2NvL2FkZi1leHRlbnNpb25zLyIsInNvdXJjZXMiOlsibGliL3NlcnZpY2VzL2V4dGVuc2lvbi1sb2FkZXIuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFpQkEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ2xELE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUErQixpQkFBaUIsRUFBRSxNQUFNLDZCQUE2QixDQUFDO0FBRTdGLE9BQU8sRUFBRSxhQUFhLEVBQUUsUUFBUSxFQUFFLFlBQVksRUFBRSxXQUFXLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQzs7O0FBSy9GO0lBSUksZ0NBQW9CLElBQWdCO1FBQWhCLFNBQUksR0FBSixJQUFJLENBQVk7SUFDcEMsQ0FBQzs7Ozs7OztJQUVELHFDQUFJOzs7Ozs7SUFBSixVQUFLLFVBQWtCLEVBQUUsV0FBbUIsRUFBRSxVQUE4QjtRQUE1RSxpQkE0Q0M7UUEzQ0csT0FBTyxJQUFJLE9BQU87Ozs7UUFBTSxVQUFDLE9BQU87WUFDNUIsS0FBSSxDQUFDLFVBQVUsQ0FBQyxVQUFVLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSTs7OztZQUFDLFVBQUMsTUFBTTtnQkFDdkMsSUFBSSxNQUFNLEVBQUU7O3dCQUNKLFFBQU0sR0FBRyxNQUFNLENBQUMsTUFBTTs7d0JBRXBCLFFBQVEsR0FBRyxjQUFjLENBQUMsT0FBTyxDQUFDLHNCQUFzQixDQUFDO29CQUMvRCxJQUFJLFFBQVEsRUFBRTt3QkFDVixRQUFNLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQztxQkFDakM7b0JBRUQsSUFBSSxRQUFNLENBQUMsV0FBVyxJQUFJLFFBQU0sQ0FBQyxXQUFXLENBQUMsTUFBTSxHQUFHLENBQUMsRUFB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LEdBQUcsTUFBTSxDQUFDLElBQUksSUFBSSxXQUFXLENBQUM7U0FDNUM7UUFDRCxPQUFPLE1BQU0sQ0FBQztJQUNsQixDQUFDOztnQkE3SUosVUFBVSxTQUFDO29CQUNSLFVBQVUsRUFBRSxNQUFNO2lCQUNyQjs7OztnQkFYUSxVQUFVOzs7aUNBakJuQjtDQXdLQyxBQTlJRCxJQThJQztTQTNJWSxzQkFBc0I7Ozs7OztJQUNuQixzQ0FBd0IiLCJzb3VyY2VzQ29udGVudCI6WyIvKiFcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgMjAxOSBBbGZyZXNjbyBTb2Z0d2FyZSwgTHRkLlxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG4gKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG5pbXBvcnQgeyBIdHRwQ2xpZW50IH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgQWN0aW9uUmVmLCBDb250ZW50QWN0aW9uUmVmLCBDb250ZW50QWN0aW9uVHlwZSB9IGZyb20gJy4uL2NvbmZpZy9hY3Rpb24uZXh0ZW5zaW9ucyc7XG5pbXBvcnQgeyBFeHRlbnNpb25FbGVtZW50IH0gZnJvbSAnLi4vY29uZmlnL2V4dGVuc2lvbi1lbGVtZW50JztcbmltcG9ydCB7IGZpbHRlckVuYWJsZWQsIGdldFZhbHVlLCBtZXJnZU9iamVjdHMsIHNvcnRCeU9yZGVyIH0gZnJvbSAnLi4vY29uZmlnL2V4dGVuc2lvbi11dGlscyc7XG5pbXBvcnQgeyBFeHRlbnNpb25Db25maWcsIEV4dGVuc2lvblJlZiB9IGZyb20gJy4uL2NvbmZpZy9leHRlbnNpb24uY29uZmlnJztcbmltcG9ydCB7IFJvdXRlUmVmIH0gZnJvbSAnLi4vY29uZmlnL3JvdXRpbmcuZXh0ZW5zaW9ucyc7XG5pbXBvcnQgeyBSdWxlUmVmIH0gZnJvbSAnLi4vY29uZmlnL3J1bGUuZXh0ZW5zaW9ucyc7XG5cbkBJbmplY3RhYmxlKHtcbiAgICBwcm92aWRlZEluOiAncm9vdCdcbn0pXG5leHBvcnQgY2xhc3MgRXh0ZW5zaW9uTG9hZGVyU2VydmljZSB7XG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBodHRwOiBIdHRwQ2xpZW50KSB7XG4gICAgfVxuXG4gICAgbG9hZChjb25maWdQYXRoOiBzdHJpbmcsIHBsdWdpbnNQYXRoOiBzdHJpbmcsIGV4dGVuc2lvbnM/OiBFeHRlbnNpb25Db25maWdbXSk6IFByb21pc2U8RXh0ZW5zaW9uQ29uZmlnPiB7XG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZTxhbnk+KChyZXNvbHZlKSA9PiB7XG4gICAgICAgICAgICB0aGlzLmxvYWRDb25maWcoY29uZmlnUGF0aCwgMCkudGhlbigocmVzdWx0KSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKHJlc3VsdCkge1xuICAgICAgICAgICAgICAgICAgICBsZXQgY29uZmlnID0gcmVzdWx0LmNvbmZpZztcblxuICAgICAgICAgICAgICAgICAgICBjb25zdCBvdmVycmlkZSA9IHNlc3Npb25TdG9yYWdlLmdldEl0ZW0oJ2FwcC5leHRlbnNpb24uY29uZmlnJyk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChvdmVycmlkZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uZmlnID0gSlNPTi5wYXJzZShvdmVycmlkZSk7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICBpZiAoY29uZmlnLiRyZWZlcmVuY2VzICYmIGNvbmZpZy4kcmVmZXJlbmNlcy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwbHVnaW5zID0gY29uZmlnLiRyZWZlcmVuY2VzLm1hcCgobmFtZSwgaWR4KSA9PlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubG9hZENvbmZpZyhgJHtwbHVnaW5zUGF0aH0vJHtuYW1lfWAsIGlkeClcbiAgICAgICAgICAgICAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIFByb21pc2UuYWxsKHBsdWdpbnMpLnRoZW4oKHJlc3VsdHMpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBjb25maWdzID0gcmVzdWx0c1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuZmlsdGVyKChlbnRyeSkgPT4gZW50cnkpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5zb3J0KHNvcnRCeU9yZGVyKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAubWFwKChlbnRyeSkgPT4gZW50cnkuY29uZmlnKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChleHRlbnNpb25zICYmIGV4dGVuc2lvbnMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25maWdzLnB1c2goLi4uZXh0ZW5zaW9ucyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbmZpZ3MubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25maWcgPSBtZXJnZU9iamVjdHMoY29uZmlnLCAuLi5jb25maWdzKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25maWcgPSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC4uLmNvbmZpZyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLi4udGhpcy5nZXRNZXRhZGF0YShyZXN1bHQuY29uZmlnKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHJlZmVyZW5jZXM6IGNvbmZpZ3MubWFwKChleHQpID0+IHRoaXMuZ2V0TWV0YWRhdGEoZXh0KSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShjb25maWcpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKGNvbmZpZyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIGdldE1ldGFkYXRhKGNvbmZpZzogRXh0ZW5zaW9uQ29uZmlnKTogRXh0ZW5zaW9uUmVmIHtcbiAgICAgICAgY29uc3QgcmVzdWx0OiBhbnkgPSB7fTtcblxuICAgICAgICBPYmplY3RcbiAgICAgICAgICAgIC5rZXlzKGNvbmZpZylcbiAgICAgICAgICAgIC5maWx0ZXIoKGtleSkgPT4ga2V5LnN0YXJ0c1dpdGgoJyQnKSlcbiAgICAgICAgICAgIC5mb3JFYWNoKChrZXkpID0+IHtcbiAgICAgICAgICAgICAgICByZXN1bHRba2V5XSA9IGNvbmZpZ1trZXldO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgbG9hZENvbmZpZyhcbiAgICAgICAgdXJsOiBzdHJpbmcsXG4gICAgICAgIG9yZGVyOiBudW1iZXJcbiAgICApOiBQcm9taXNlPHsgb3JkZXI6IG51bWJlcjsgY29uZmlnOiBFeHRlbnNpb25Db25maWcgfT4ge1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcbiAgICAgICAgICAgIHRoaXMuaHR0cC5nZXQ8RXh0ZW5zaW9uQ29uZmlnPih1cmwpLnN1YnNjcmliZShcbiAgICAgICAgICAgICAgICAoY29uZmlnKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUoe1xuICAgICAgICAgICAgICAgICAgICAgICAgb3JkZXIsXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25maWdcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUobnVsbCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmV0cmlldmVzIGNvbmZpZ3VyYXRpb24gZWxlbWVudHMuXG4gICAgICogRmlsdGVycyBlbGVtZW50IGJ5ICoqZW5hYmxlZCoqIGFuZCAqKm9yZGVyKiogYXR0cmlidXRlcy5cbiAgICAgKiBFeGFtcGxlOlxuICAgICAqICBgZ2V0RWxlbWVudHM8Vmlld2VyRXh0ZW5zaW9uUmVmPihjb25maWcsICdmZWF0dXJlcy52aWV3ZXIuY29udGVudCcpYFxuICAgICAqL1xuICAgIGdldEVsZW1lbnRzPFQgZXh0ZW5kcyBFeHRlbnNpb25FbGVtZW50PihcbiAgICAgICAgY29uZmlnOiBFeHRlbnNpb25Db25maWcsXG4gICAgICAgIGtleTogc3RyaW5nLFxuICAgICAgICBmYWxsYmFjazogQXJyYXk8VD4gPSBbXVxuICAgICk6IEFycmF5PFQ+IHtcbiAgICAgICAgY29uc3QgdmFsdWVzID0gZ2V0VmFsdWUoY29uZmlnLCBrZXkpIHx8IGZhbGxiYWNrIHx8IFtdO1xuICAgICAgICByZXR1cm4gdmFsdWVzLmZpbHRlcihmaWx0ZXJFbmFibGVkKS5zb3J0KHNvcnRCeU9yZGVyKTtcbiAgICB9XG5cbiAgICBnZXRDb250ZW50QWN0aW9ucyhcbiAgICAgICAgY29uZmlnOiBFeHRlbnNpb25Db25maWcsXG4gICAgICAgIGtleTogc3RyaW5nXG4gICAgKTogQXJyYXk8Q29udGVudEFjdGlvblJlZj4ge1xuICAgICAgICByZXR1cm4gdGhpcy5nZXRFbGVtZW50cyhjb25maWcsIGtleSkubWFwKHRoaXMuc2V0QWN0aW9uRGVmYXVsdHMpO1xuICAgIH1cblxuICAgIGdldFJ1bGVzKGNvbmZpZzogRXh0ZW5zaW9uQ29uZmlnKTogQXJyYXk8UnVsZVJlZj4ge1xuICAgICAgICBpZiAoY29uZmlnICYmIGNvbmZpZy5ydWxlcykge1xuICAgICAgICAgICAgcmV0dXJuIGNvbmZpZy5ydWxlcztcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gW107XG4gICAgfVxuXG4gICAgZ2V0Um91dGVzKGNvbmZpZzogRXh0ZW5zaW9uQ29uZmlnKTogQXJyYXk8Um91dGVSZWY+IHtcbiAgICAgICAgaWYgKGNvbmZpZykge1xuICAgICAgICAgICAgcmV0dXJuIGNvbmZpZy5yb3V0ZXMgfHwgW107XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIFtdO1xuICAgIH1cblxuICAgIGdldEFjdGlvbnMoY29uZmlnOiBFeHRlbnNpb25Db25maWcpOiBBcnJheTxBY3Rpb25SZWY+IHtcbiAgICAgICAgaWYgKGNvbmZpZykge1xuICAgICAgICAgICAgcmV0dXJuIGNvbmZpZy5hY3Rpb25zIHx8IFtdO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBbXTtcbiAgICB9XG5cbiAgICBnZXRGZWF0dXJlcyhjb25maWc6IEV4dGVuc2lvbkNvbmZpZyk6IGFueSB7XG4gICAgICAgIGlmIChjb25maWcpIHtcbiAgICAgICAgICAgIHJldHVybiBjb25maWcuZmVhdHVyZXMgfHwgW107XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIFtdO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBzZXRBY3Rpb25EZWZhdWx0cyhhY3Rpb246IENvbnRlbnRBY3Rpb25SZWYpOiBDb250ZW50QWN0aW9uUmVmIHtcbiAgICAgICAgaWYgKGFjdGlvbikge1xuICAgICAgICAgICAgYWN0aW9uLnR5cGUgPSBhY3Rpb24udHlwZSB8fCBDb250ZW50QWN0aW9uVHlwZS5kZWZhdWx0O1xuICAgICAgICAgICAgYWN0aW9uLmljb24gPSBhY3Rpb24uaWNvbiB8fCAnZXh0ZW5zaW9uJztcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gYWN0aW9uO1xuICAgIH1cbn1cbiJdfQ==