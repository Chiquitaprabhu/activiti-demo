/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
/*!
 * @license
 * Copyright 2019 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/* tslint:disable:component-selector  */
import { FormFieldEvent } from './../../../events/form-field.event';
import { ValidateFormFieldEvent } from './../../../events/validate-form-field.event';
import { ValidateFormEvent } from './../../../events/validate-form.event';
import { ContainerModel } from './container.model';
import { FormFieldTypes } from './form-field-types';
import { FormFieldModel } from './form-field.model';
import { FormOutcomeModel } from './form-outcome.model';
import { TabModel } from './tab.model';
import { FORM_FIELD_VALIDATORS } from './form-field-validator';
import { FormBaseModel } from '../../form-base.model';
var FormModel = /** @class */ (function (_super) {
    tslib_1.__extends(FormModel, _super);
    function FormModel(formRepresentationJSON, formValues, readOnly, formService) {
        if (readOnly === void 0) { readOnly = false; }
        var _this = _super.call(this) || this;
        _this.formService = formService;
        _this.taskName = FormModel.UNSET_TASK_NAME;
        _this.customFieldTemplates = {};
        _this.fieldValidators = tslib_1.__spread(FORM_FIELD_VALIDATORS);
        _this.readOnly = readOnly;
        if (formRepresentationJSON) {
            _this.json = formRepresentationJSON;
            _this.id = formRepresentationJSON.id;
            _this.name = formRepresentationJSON.name;
            _this.taskId = formRepresentationJSON.taskId;
            _this.taskName = formRepresentationJSON.taskName || formRepresentationJSON.name || FormModel.UNSET_TASK_NAME;
            _this.processDefinitionId = formRepresentationJSON.processDefinitionId;
            _this.customFieldTemplates = formRepresentationJSON.customFieldTemplates || {};
            _this.selectedOutcome = formRepresentationJSON.selectedOutcome || {};
            _this.className = formRepresentationJSON.className || '';
            /** @type {?} */
            var tabCache_1 = {};
            _this.processVariables = formRepresentationJSON.processVariables;
            _this.tabs = (formRepresentationJSON.tabs || []).map((/**
             * @param {?} t
             * @return {?}
             */
            function (t) {
                /** @type {?} */
                var model = new TabModel(_this, t);
                tabCache_1[model.id] = model;
                return model;
            }));
            _this.fields = _this.parseRootFields(formRepresentationJSON);
            if (formValues) {
                _this.loadData(formValues);
            }
            for (var i = 0; i < _this.fields.length; i++) {
                /** @type {?} */
                var field = _this.fields[i];
                if (field.tab) {
                    /** @type {?} */
                    var tab = tabCache_1[field.tab];
                    if (tab) {
                        tab.fields.push(field);
                    }
                }
            }
            if (formRepresentationJSON.fields) {
                /** @type {?} */
                var saveOutcome = new FormOutcomeModel(_this, {
                    id: FormModel.SAVE_OUTCOME,
                    name: 'SAVE',
                    isSystem: true
                });
                /** @type {?} */
                var completeOutcome = new FormOutcomeModel(_this, {
                    id: FormModel.COMPLETE_OUTCOME,
                    name: 'COMPLETE',
                    isSystem: true
                });
                /** @type {?} */
                var startProcessOutcome = new FormOutcomeModel(_this, {
                    id: FormModel.START_PROCESS_OUTCOME,
                    name: 'START PROCESS',
                    isSystem: true
                });
                /** @type {?} */
                var customOutcomes = (formRepresentationJSON.outcomes || []).map((/**
                 * @param {?} obj
                 * @return {?}
                 */
                function (obj) { return new FormOutcomeModel(_this, obj); }));
                _this.outcomes = [saveOutcome].concat(customOutcomes.length > 0 ? customOutcomes : [completeOutcome, startProcessOutcome]);
            }
        }
        _this.validateForm();
        return _this;
    }
    /**
     * @param {?} field
     * @return {?}
     */
    FormModel.prototype.onFormFieldChanged = /**
     * @param {?} field
     * @return {?}
     */
    function (field) {
        this.validateField(field);
        if (this.formService) {
            this.formService.formFieldValueChanged.next(new FormFieldEvent(this, field));
        }
    };
    /**
     * Validates entire form and all form fields.
     *
     * @memberof FormModel
     */
    /**
     * Validates entire form and all form fields.
     *
     * \@memberof FormModel
     * @return {?}
     */
    FormModel.prototype.validateForm = /**
     * Validates entire form and all form fields.
     *
     * \@memberof FormModel
     * @return {?}
     */
    function () {
        /** @type {?} */
        var validateFormEvent = new ValidateFormEvent(this);
        /** @type {?} */
        var errorsField = [];
        /** @type {?} */
        var fields = this.getFormFields();
        for (var i = 0; i < fields.length; i++) {
            if (!fields[i].validate()) {
                errorsField.push(fields[i]);
            }
        }
        this.isValid = errorsField.length > 0 ? false : true;
        if (this.formService) {
            validateFormEvent.isValid = this.isValid;
            validateFormEvent.errorsField = errorsField;
            this.formService.validateForm.next(validateFormEvent);
        }
    };
    /**
     * Validates a specific form field, triggers form validation.
     *
     * @param field Form field to validate.
     * @memberof FormModel
     */
    /**
     * Validates a specific form field, triggers form validation.
     *
     * \@memberof FormModel
     * @param {?} field Form field to validate.
     * @return {?}
     */
    FormModel.prototype.validateField = /**
     * Validates a specific form field, triggers form validation.
     *
     * \@memberof FormModel
     * @param {?} field Form field to validate.
     * @return {?}
     */
    function (field) {
        if (!field) {
            return;
        }
        /** @type {?} */
        var validateFieldEvent = new ValidateFormFieldEvent(this, field);
        if (this.formService) {
            this.formService.validateFormField.next(validateFieldEvent);
        }
        if (!validateFieldEvent.isValid) {
            this.markAsInvalid();
            return;
        }
        if (validateFieldEvent.defaultPrevented) {
            return;
        }
        if (!field.validate()) {
            this.markAsInvalid();
        }
        this.validateForm();
    };
    // Activiti supports 3 types of root fields: container|group|dynamic-table
    // Activiti supports 3 types of root fields: container|group|dynamic-table
    /**
     * @private
     * @param {?} json
     * @return {?}
     */
    FormModel.prototype.parseRootFields = 
    // Activiti supports 3 types of root fields: container|group|dynamic-table
    /**
     * @private
     * @param {?} json
     * @return {?}
     */
    function (json) {
        var e_1, _a;
        /** @type {?} */
        var fields = [];
        if (json.fields) {
            fields = json.fields;
        }
        else if (json.formDefinition && json.formDefinition.fields) {
            fields = json.formDefinition.fields;
        }
        /** @type {?} */
        var formWidgetModel = [];
        try {
            for (var fields_1 = tslib_1.__values(fields), fields_1_1 = fields_1.next(); !fields_1_1.done; fields_1_1 = fields_1.next()) {
                var field = fields_1_1.value;
                if (field.type === FormFieldTypes.DISPLAY_VALUE) {
                    // workaround for dynamic table on a completed/readonly form
                    if (field.params) {
                        /** @type {?} */
                        var originalField = field.params['field'];
                        if (originalField.type === FormFieldTypes.DYNAMIC_TABLE) {
                            formWidgetModel.push(new ContainerModel(new FormFieldModel(this, field)));
                        }
                    }
                }
                else {
                    formWidgetModel.push(new ContainerModel(new FormFieldModel(this, field)));
                }
            }
        }
        catch (e_1_1) { e_1 = { error: e_1_1 }; }
        finally {
            try {
                if (fields_1_1 && !fields_1_1.done && (_a = fields_1.return)) _a.call(fields_1);
            }
            finally { if (e_1) throw e_1.error; }
        }
        return formWidgetModel;
    };
    // Loads external data and overrides field values
    // Typically used when form definition and form data coming from different sources
    // Loads external data and overrides field values
    // Typically used when form definition and form data coming from different sources
    /**
     * @private
     * @param {?} formValues
     * @return {?}
     */
    FormModel.prototype.loadData = 
    // Loads external data and overrides field values
    // Typically used when form definition and form data coming from different sources
    /**
     * @private
     * @param {?} formValues
     * @return {?}
     */
    function (formValues) {
        var e_2, _a;
        try {
            for (var _b = tslib_1.__values(this.getFormFields()), _c = _b.next(); !_c.done; _c = _b.next()) {
                var field = _c.value;
                if (formValues[field.id]) {
                    field.json.value = formValues[field.id];
                    field.value = field.parseValue(field.json);
                }
            }
        }
        catch (e_2_1) { e_2 = { error: e_2_1 }; }
        finally {
            try {
                if (_c && !_c.done && (_a = _b.return)) _a.call(_b);
            }
            finally { if (e_2) throw e_2.error; }
        }
    };
    return FormModel;
}(FormBaseModel));
export { FormModel };
if (false) {
    /** @type {?} */
    FormModel.prototype.id;
    /** @type {?} */
    FormModel.prototype.name;
    /** @type {?} */
    FormModel.prototype.taskId;
    /** @type {?} */
    FormModel.prototype.taskName;
    /** @type {?} */
    FormModel.prototype.processDefinitionId;
    /** @type {?} */
    FormModel.prototype.customFieldTemplates;
    /** @type {?} */
    FormModel.prototype.fieldValidators;
    /** @type {?} */
    FormModel.prototype.selectedOutcome;
    /** @type {?} */
    FormModel.prototype.processVariables;
    /**
     * @type {?}
     * @protected
     */
    FormModel.prototype.formService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZm9ybS5tb2RlbC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BhbGZyZXNjby9hZGYtY29yZS8iLCJzb3VyY2VzIjpbImZvcm0vY29tcG9uZW50cy93aWRnZXRzL2NvcmUvZm9ybS5tb2RlbC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBbUJBLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxvQ0FBb0MsQ0FBQztBQUNwRSxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSw2Q0FBNkMsQ0FBQztBQUNyRixPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSx1Q0FBdUMsQ0FBQztBQUUxRSxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFFbkQsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQ3BELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUNwRCxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUd4RCxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBRXZDLE9BQU8sRUFDSCxxQkFBcUIsRUFFeEIsTUFBTSx3QkFBd0IsQ0FBQztBQUNoQyxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFFdEQ7SUFBK0IscUNBQWE7SUFjeEMsbUJBQVksc0JBQTRCLEVBQUUsVUFBdUIsRUFBRSxRQUF5QixFQUFZLFdBQXlCO1FBQTlELHlCQUFBLEVBQUEsZ0JBQXlCO1FBQTVGLFlBQ0ksaUJBQU8sU0FtRVY7UUFwRXVHLGlCQUFXLEdBQVgsV0FBVyxDQUFjO1FBVHhILGNBQVEsR0FBVyxTQUFTLENBQUMsZUFBZSxDQUFDO1FBR3RELDBCQUFvQixHQUF1QixFQUFFLENBQUM7UUFDOUMscUJBQWUsb0JBQTZCLHFCQUFxQixFQUFFO1FBTy9ELEtBQUksQ0FBQyxRQUFRLEdBQUcsUUFBUSxDQUFDO1FBRXpCLElB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QUMsQ0FBQztvQkFDeEMsS0FBSyxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztpQkFDOUM7YUFDSjs7Ozs7Ozs7O0lBQ0wsQ0FBQztJQUNMLGdCQUFDO0FBQUQsQ0FBQyxBQTlMRCxDQUErQixhQUFhLEdBOEwzQzs7OztJQTVMRyx1QkFBb0I7O0lBQ3BCLHlCQUFzQjs7SUFDdEIsMkJBQXdCOztJQUN4Qiw2QkFBc0Q7O0lBQ3RELHdDQUE0Qjs7SUFFNUIseUNBQThDOztJQUM5QyxvQ0FBbUU7O0lBQ25FLG9DQUFpQzs7SUFFakMscUNBQXNCOzs7OztJQUV3RSxnQ0FBbUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiFcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgMjAxOSBBbGZyZXNjbyBTb2Z0d2FyZSwgTHRkLlxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG4gKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG4vKiB0c2xpbnQ6ZGlzYWJsZTpjb21wb25lbnQtc2VsZWN0b3IgICovXG5cbmltcG9ydCB7IEZvcm1GaWVsZEV2ZW50IH0gZnJvbSAnLi8uLi8uLi8uLi9ldmVudHMvZm9ybS1maWVsZC5ldmVudCc7XG5pbXBvcnQgeyBWYWxpZGF0ZUZvcm1GaWVsZEV2ZW50IH0gZnJvbSAnLi8uLi8uLi8uLi9ldmVudHMvdmFsaWRhdGUtZm9ybS1maWVsZC5ldmVudCc7XG5pbXBvcnQgeyBWYWxpZGF0ZUZvcm1FdmVudCB9IGZyb20gJy4vLi4vLi4vLi4vZXZlbnRzL3ZhbGlkYXRlLWZvcm0uZXZlbnQnO1xuaW1wb3J0IHsgRm9ybVNlcnZpY2UgfSBmcm9tICcuLy4uLy4uLy4uL3NlcnZpY2VzL2Zvcm0uc2VydmljZSc7XG5pbXBvcnQgeyBDb250YWluZXJNb2RlbCB9IGZyb20gJy4vY29udGFpbmVyLm1vZGVsJztcbmltcG9ydCB7IEZvcm1GaWVsZFRlbXBsYXRlcyB9IGZyb20gJy4vZm9ybS1maWVsZC10ZW1wbGF0ZXMnO1xuaW1wb3J0IHsgRm9ybUZpZWxkVHlwZXMgfSBmcm9tICcuL2Zvcm0tZmllbGQtdHlwZXMnO1xuaW1wb3J0IHsgRm9ybUZpZWxkTW9kZWwgfSBmcm9tICcuL2Zvcm0tZmllbGQubW9kZWwnO1xuaW1wb3J0IHsgRm9ybU91dGNvbWVNb2RlbCB9IGZyb20gJy4vZm9ybS1vdXRjb21lLm1vZGVsJztcbmltcG9ydCB7IEZvcm1WYWx1ZXMgfSBmcm9tICcuL2Zvcm0tdmFsdWVzJztcbmltcG9ydCB7IEZvcm1XaWRnZXRNb2RlbCwgRm9ybVdpZGdldE1vZGVsQ2FjaGUgfSBmcm9tICcuL2Zvcm0td2lkZ2V0Lm1vZGVsJztcbmltcG9ydCB7IFRhYk1vZGVsIH0gZnJvbSAnLi90YWIubW9kZWwnO1xuXG5pbXBvcnQge1xuICAgIEZPUk1fRklFTERfVkFMSURBVE9SUyxcbiAgICBGb3JtRmllbGRWYWxpZGF0b3Jcbn0gZnJvbSAnLi9mb3JtLWZpZWxkLXZhbGlkYXRvcic7XG5pbXBvcnQgeyBGb3JtQmFzZU1vZGVsIH0gZnJvbSAnLi4vLi4vZm9ybS1iYXNlLm1vZGVsJztcblxuZXhwb3J0IGNsYXNzIEZvcm1Nb2RlbCBleHRlbmRzIEZvcm1CYXNlTW9kZWwge1xuXG4gICAgcmVhZG9ubHkgaWQ6IG51bWJlcjtcbiAgICByZWFkb25seSBuYW1lOiBzdHJpbmc7XG4gICAgcmVhZG9ubHkgdGFza0lkOiBzdHJpbmc7XG4gICAgcmVhZG9ubHkgdGFza05hbWU6IHN0cmluZyA9IEZvcm1Nb2RlbC5VTlNFVF9UQVNLX05BTUU7XG4gICAgcHJvY2Vzc0RlZmluaXRpb25JZDogc3RyaW5nO1xuXG4gICAgY3VzdG9tRmllbGRUZW1wbGF0ZXM6IEZvcm1GaWVsZFRlbXBsYXRlcyA9IHt9O1xuICAgIGZpZWxkVmFsaWRhdG9yczogRm9ybUZpZWxkVmFsaWRhdG9yW10gPSBbLi4uRk9STV9GSUVMRF9WQUxJREFUT1JTXTtcbiAgICByZWFkb25seSBzZWxlY3RlZE91dGNvbWU6IHN0cmluZztcblxuICAgIHByb2Nlc3NWYXJpYWJsZXM6IGFueTtcblxuICAgIGNvbnN0cnVjdG9yKGZvcm1SZXByZXNlbnRhdGlvbkpTT04/OiBhbnksIGZvcm1WYWx1ZXM/OiBGb3JtVmFsdWVzLCByZWFkT25seTogYm9vbGVhbiA9IGZhbHNlLCBwcm90ZWN0ZWQgZm9ybVNlcnZpY2U/OiBGb3JtU2VydmljZSkge1xuICAgICAgICBzdXBlcigpO1xuICAgICAgICB0aGlzLnJlYWRPbmx5ID0gcmVhZE9ubHk7XG5cbiAgICAgICAgaWYgKGZvcm1SZXByZXNlbnRhdGlvbkpTT04pIHtcbiAgICAgICAgICAgIHRoaXMuanNvbiA9IGZvcm1SZXByZXNlbnRhdGlvbkpTT047XG5cbiAgICAgICAgICAgIHRoaXMuaWQgPSBmb3JtUmVwcmVzZW50YXRpb25KU09OLmlkO1xuICAgICAgICAgICAgdGhpcy5uYW1lID0gZm9ybVJlcHJlc2VudGF0aW9uSlNPTi5uYW1lO1xuICAgICAgICAgICAgdGhpcy50YXNrSWQgPSBmb3JtUmVwcmVzZW50YXRpb25KU09OLnRhc2tJZDtcbiAgICAgICAgICAgIHRoaXMudGFza05hbWUgPSBmb3JtUmVwcmVzZW50YXRpb25KU09OLnRhc2tOYW1lIHx8IGZvcm1SZXByZXNlbnRhdGlvbkpTT04ubmFtZSB8fCBGb3JtTW9kZWwuVU5TRVRfVEFTS19OQU1FO1xuICAgICAgICAgICAgdGhpcy5wcm9jZXNzRGVmaW5pdGlvbklkID0gZm9ybVJlcHJlc2VudGF0aW9uSlNPTi5wcm9jZXNzRGVmaW5pdGlvbklkO1xuICAgICAgICAgICAgdGhpcy5jdXN0b21GaWVsZFRlbXBsYXRlcyA9IGZvcm1SZXByZXNlbnRhdGlvbkpTT04uY3VzdG9tRmllbGRUZW1wbGF0ZXMgfHwge307XG4gICAgICAgICAgICB0aGlzLnNlbGVjdGVkT3V0Y29tZSA9IGZvcm1SZXByZXNlbnRhdGlvbkpTT04uc2VsZWN0ZWRPdXRjb21lIHx8IHt9O1xuICAgICAgICAgICAgdGhpcy5jbGFzc05hbWUgPSBmb3JtUmVwcmVzZW50YXRpb25KU09OLmNsYXNzTmFtZSB8fCAnJztcblxuICAgICAgICAgICAgY29uc3QgdGFiQ2FjaGU6IEZvcm1XaWRnZXRNb2RlbENhY2hlPFRhYk1vZGVsPiA9IHt9O1xuXG4gICAgICAgICAgICB0aGlzLnByb2Nlc3NWYXJpYWJsZXMgPSBmb3JtUmVwcmVzZW50YXRpb25KU09OLnByb2Nlc3NWYXJpYWJsZXM7XG5cbiAgICAgICAgICAgIHRoaXMudGFicyA9IChmb3JtUmVwcmVzZW50YXRpb25KU09OLnRhYnMgfHwgW10pLm1hcCgodCkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IG1vZGVsID0gbmV3IFRhYk1vZGVsKHRoaXMsIHQpO1xuICAgICAgICAgICAgICAgIHRhYkNhY2hlW21vZGVsLmlkXSA9IG1vZGVsO1xuICAgICAgICAgICAgICAgIHJldHVybiBtb2RlbDtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICB0aGlzLmZpZWxkcyA9IHRoaXMucGFyc2VSb290RmllbGRzKGZvcm1SZXByZXNlbnRhdGlvbkpTT04pO1xuXG4gICAgICAgICAgICBpZiAoZm9ybVZhbHVlcykge1xuICAgICAgICAgICAgICAgIHRoaXMubG9hZERhdGEoZm9ybVZhbHVlcyk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5maWVsZHMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICBjb25zdCBmaWVsZCA9IHRoaXMuZmllbGRzW2ldO1xuICAgICAgICAgICAgICAgIGlmIChmaWVsZC50YWIpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgdGFiID0gdGFiQ2FjaGVbZmllbGQudGFiXTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRhYikge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGFiLmZpZWxkcy5wdXNoKGZpZWxkKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKGZvcm1SZXByZXNlbnRhdGlvbkpTT04uZmllbGRzKSB7XG4gICAgICAgICAgICAgICAgY29uc3Qgc2F2ZU91dGNvbWUgPSBuZXcgRm9ybU91dGNvbWVNb2RlbCh0aGlzLCB7XG4gICAgICAgICAgICAgICAgICAgIGlkOiBGb3JtTW9kZWwuU0FWRV9PVVRDT01FLFxuICAgICAgICAgICAgICAgICAgICBuYW1lOiAnU0FWRScsXG4gICAgICAgICAgICAgICAgICAgIGlzU3lzdGVtOiB0cnVlXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgY29uc3QgY29tcGxldGVPdXRjb21lID0gbmV3IEZvcm1PdXRjb21lTW9kZWwodGhpcywge1xuICAgICAgICAgICAgICAgICAgICBpZDogRm9ybU1vZGVsLkNPTVBMRVRFX09VVENPTUUsXG4gICAgICAgICAgICAgICAgICAgIG5hbWU6ICdDT01QTEVURScsXG4gICAgICAgICAgICAgICAgICAgIGlzU3lzdGVtOiB0cnVlXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgY29uc3Qgc3RhcnRQcm9jZXNzT3V0Y29tZSA9IG5ldyBGb3JtT3V0Y29tZU1vZGVsKHRoaXMsIHtcbiAgICAgICAgICAgICAgICAgICAgaWQ6IEZvcm1Nb2RlbC5TVEFSVF9QUk9DRVNTX09VVENPTUUsXG4gICAgICAgICAgICAgICAgICAgIG5hbWU6ICdTVEFSVCBQUk9DRVNTJyxcbiAgICAgICAgICAgICAgICAgICAgaXNTeXN0ZW06IHRydWVcbiAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgIGNvbnN0IGN1c3RvbU91dGNvbWVzID0gKGZvcm1SZXByZXNlbnRhdGlvbkpTT04ub3V0Y29tZXMgfHwgW10pLm1hcCgob2JqKSA9PiBuZXcgRm9ybU91dGNvbWVNb2RlbCh0aGlzLCBvYmopKTtcblxuICAgICAgICAgICAgICAgIHRoaXMub3V0Y29tZXMgPSBbc2F2ZU91dGNvbWVdLmNvbmNhdChcbiAgICAgICAgICAgICAgICAgICAgY3VzdG9tT3V0Y29tZXMubGVuZ3RoID4gMCA/IGN1c3RvbU91dGNvbWVzIDogW2NvbXBsZXRlT3V0Y29tZSwgc3RhcnRQcm9jZXNzT3V0Y29tZV1cbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy52YWxpZGF0ZUZvcm0oKTtcbiAgICB9XG5cbiAgICBvbkZvcm1GaWVsZENoYW5nZWQoZmllbGQ6IEZvcm1GaWVsZE1vZGVsKSB7XG4gICAgICAgIHRoaXMudmFsaWRhdGVGaWVsZChmaWVsZCk7XG4gICAgICAgIGlmICh0aGlzLmZvcm1TZXJ2aWNlKSB7XG4gICAgICAgICAgICB0aGlzLmZvcm1TZXJ2aWNlLmZvcm1GaWVsZFZhbHVlQ2hhbmdlZC5uZXh0KG5ldyBGb3JtRmllbGRFdmVudCh0aGlzLCBmaWVsZCkpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVmFsaWRhdGVzIGVudGlyZSBmb3JtIGFuZCBhbGwgZm9ybSBmaWVsZHMuXG4gICAgICpcbiAgICAgKiBAbWVtYmVyb2YgRm9ybU1vZGVsXG4gICAgICovXG4gICAgdmFsaWRhdGVGb3JtKCk6IHZvaWQge1xuICAgICAgICBjb25zdCB2YWxpZGF0ZUZvcm1FdmVudDogYW55ID0gbmV3IFZhbGlkYXRlRm9ybUV2ZW50KHRoaXMpO1xuXG4gICAgICAgIGNvbnN0IGVycm9yc0ZpZWxkOiBGb3JtRmllbGRNb2RlbFtdID0gW107XG5cbiAgICAgICAgY29uc3QgZmllbGRzID0gdGhpcy5nZXRGb3JtRmllbGRzKCk7XG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZmllbGRzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICBpZiAoIWZpZWxkc1tpXS52YWxpZGF0ZSgpKSB7XG4gICAgICAgICAgICAgICAgZXJyb3JzRmllbGQucHVzaChmaWVsZHNbaV0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5pc1ZhbGlkID0gZXJyb3JzRmllbGQubGVuZ3RoID4gMCA/IGZhbHNlIDogdHJ1ZTtcblxuICAgICAgICBpZiAodGhpcy5mb3JtU2VydmljZSkge1xuICAgICAgICAgICAgdmFsaWRhdGVGb3JtRXZlbnQuaXNWYWxpZCA9IHRoaXMuaXNWYWxpZDtcbiAgICAgICAgICAgIHZhbGlkYXRlRm9ybUV2ZW50LmVycm9yc0ZpZWxkID0gZXJyb3JzRmllbGQ7XG4gICAgICAgICAgICB0aGlzLmZvcm1TZXJ2aWNlLnZhbGlkYXRlRm9ybS5uZXh0KHZhbGlkYXRlRm9ybUV2ZW50KTtcbiAgICAgICAgfVxuXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVmFsaWRhdGVzIGEgc3BlY2lmaWMgZm9ybSBmaWVsZCwgdHJpZ2dlcnMgZm9ybSB2YWxpZGF0aW9uLlxuICAgICAqXG4gICAgICogQHBhcmFtIGZpZWxkIEZvcm0gZmllbGQgdG8gdmFsaWRhdGUuXG4gICAgICogQG1lbWJlcm9mIEZvcm1Nb2RlbFxuICAgICAqL1xuICAgIHZhbGlkYXRlRmllbGQoZmllbGQ6IEZvcm1GaWVsZE1vZGVsKTogdm9pZCB7XG4gICAgICAgIGlmICghZmllbGQpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHZhbGlkYXRlRmllbGRFdmVudCA9IG5ldyBWYWxpZGF0ZUZvcm1GaWVsZEV2ZW50KHRoaXMsIGZpZWxkKTtcblxuICAgICAgICBpZiAodGhpcy5mb3JtU2VydmljZSkge1xuICAgICAgICAgICAgdGhpcy5mb3JtU2VydmljZS52YWxpZGF0ZUZvcm1GaWVsZC5uZXh0KHZhbGlkYXRlRmllbGRFdmVudCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIXZhbGlkYXRlRmllbGRFdmVudC5pc1ZhbGlkKSB7XG4gICAgICAgICAgICB0aGlzLm1hcmtBc0ludmFsaWQoKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh2YWxpZGF0ZUZpZWxkRXZlbnQuZGVmYXVsdFByZXZlbnRlZCkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCFmaWVsZC52YWxpZGF0ZSgpKSB7XG4gICAgICAgICAgICB0aGlzLm1hcmtBc0ludmFsaWQoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMudmFsaWRhdGVGb3JtKCk7XG4gICAgfVxuXG4gICAgLy8gQWN0aXZpdGkgc3VwcG9ydHMgMyB0eXBlcyBvZiByb290IGZpZWxkczogY29udGFpbmVyfGdyb3VwfGR5bmFtaWMtdGFibGVcbiAgICBwcml2YXRlIHBhcnNlUm9vdEZpZWxkcyhqc29uOiBhbnkpOiBGb3JtV2lkZ2V0TW9kZWxbXSB7XG4gICAgICAgIGxldCBmaWVsZHMgPSBbXTtcblxuICAgICAgICBpZiAoanNvbi5maWVsZHMpIHtcbiAgICAgICAgICAgIGZpZWxkcyA9IGpzb24uZmllbGRzO1xuICAgICAgICB9IGVsc2UgaWYgKGpzb24uZm9ybURlZmluaXRpb24gJiYganNvbi5mb3JtRGVmaW5pdGlvbi5maWVsZHMpIHtcbiAgICAgICAgICAgIGZpZWxkcyA9IGpzb24uZm9ybURlZmluaXRpb24uZmllbGRzO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgZm9ybVdpZGdldE1vZGVsOiBGb3JtV2lkZ2V0TW9kZWxbXSA9IFtdO1xuXG4gICAgICAgIGZvciAoY29uc3QgZmllbGQgb2YgZmllbGRzKSB7XG4gICAgICAgICAgICBpZiAoZmllbGQudHlwZSA9PT0gRm9ybUZpZWxkVHlwZXMuRElTUExBWV9WQUxVRSkge1xuICAgICAgICAgICAgICAgIC8vIHdvcmthcm91bmQgZm9yIGR5bmFtaWMgdGFibGUgb24gYSBjb21wbGV0ZWQvcmVhZG9ubHkgZm9ybVxuICAgICAgICAgICAgICAgIGlmIChmaWVsZC5wYXJhbXMpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgb3JpZ2luYWxGaWVsZCA9IGZpZWxkLnBhcmFtc1snZmllbGQnXTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKG9yaWdpbmFsRmllbGQudHlwZSA9PT0gRm9ybUZpZWxkVHlwZXMuRFlOQU1JQ19UQUJMRSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZm9ybVdpZGdldE1vZGVsLnB1c2gobmV3IENvbnRhaW5lck1vZGVsKG5ldyBGb3JtRmllbGRNb2RlbCh0aGlzLCBmaWVsZCkpKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgZm9ybVdpZGdldE1vZGVsLnB1c2gobmV3IENvbnRhaW5lck1vZGVsKG5ldyBGb3JtRmllbGRNb2RlbCh0aGlzLCBmaWVsZCkpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBmb3JtV2lkZ2V0TW9kZWw7XG4gICAgfVxuXG4gICAgLy8gTG9hZHMgZXh0ZXJuYWwgZGF0YSBhbmQgb3ZlcnJpZGVzIGZpZWxkIHZhbHVlc1xuICAgIC8vIFR5cGljYWxseSB1c2VkIHdoZW4gZm9ybSBkZWZpbml0aW9uIGFuZCBmb3JtIGRhdGEgY29taW5nIGZyb20gZGlmZmVyZW50IHNvdXJjZXNcbiAgICBwcml2YXRlIGxvYWREYXRhKGZvcm1WYWx1ZXM6IEZvcm1WYWx1ZXMpIHtcbiAgICAgICAgZm9yIChjb25zdCBmaWVsZCBvZiB0aGlzLmdldEZvcm1GaWVsZHMoKSkge1xuICAgICAgICAgICAgaWYgKGZvcm1WYWx1ZXNbZmllbGQuaWRdKSB7XG4gICAgICAgICAgICAgICAgZmllbGQuanNvbi52YWx1ZSA9IGZvcm1WYWx1ZXNbZmllbGQuaWRdO1xuICAgICAgICAgICAgICAgIGZpZWxkLnZhbHVlID0gZmllbGQucGFyc2VWYWx1ZShmaWVsZC5qc29uKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbn1cbiJdfQ==